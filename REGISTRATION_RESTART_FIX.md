# üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ –ü–ï–†–ï–ó–ê–ü–£–°–ö–ê –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò

## ‚ùå –ü–†–û–ë–õ–ï–ú–ê –° –ü–ï–†–ï–ó–ê–ü–£–°–ö–û–ú –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò

–ü–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "‚ùå –ï—Å—Ç—å –æ—à–∏–±–∫–∏" (–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–ª –æ—à–∏–±–∫—É:

```
‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.
```

**–ü—Ä–∏—á–∏–Ω–∞:** –í —Ñ—É–Ω–∫—Ü–∏–∏ `handle_registration_restart()` –æ—á–∏—â–∞–ª–∏—Å—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –Ω–æ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª–∞—Å—å –±–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö. –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏–ª –§–ò–û, —Ñ—É–Ω–∫—Ü–∏—è `handle_full_name_input()` –ø—ã—Ç–∞–ª–∞—Å—å –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ `context.user_data['registration_data']`, –∫–æ—Ç–æ—Ä–æ–≥–æ —É–∂–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–æ.

## üîç –ê–ù–ê–õ–ò–ó –ü–†–û–ë–õ–ï–ú–´

### –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:
```python
async def handle_registration_restart(query, context):
    try:
        # –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
        context.user_data.pop('registration_data', None)  # ‚Üê –ü–†–û–ë–õ–ï–ú–ê: –ø–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
        context.user_data['waiting_for_full_name'] = True
        
        await query.edit_message_text(...)
```

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–ª "‚ùå –ï—Å—Ç—å –æ—à–∏–±–∫–∏"
2. –§—É–Ω–∫—Ü–∏—è `handle_registration_restart()` **–ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª—è–ª–∞** `registration_data`
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏–ª –Ω–æ–≤–æ–µ –§–ò–û
4. –§—É–Ω–∫—Ü–∏—è `handle_full_name_input()` –ø—ã—Ç–∞–ª–∞—Å—å –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ `context.user_data['registration_data']['full_name']`
5. **KeyError** - –∫–ª—é—á `registration_data` –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª
6. Exception –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–ª—Å—è –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–ª –æ–±—â—É—é –æ—à–∏–±–∫—É

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥:
```python
async def handle_registration_restart(query, context):
    try:
        # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user = query.from_user
        user_id = user.id
        first_name = getattr(user, "first_name", "")
        last_name = getattr(user, "last_name", "")
        username = getattr(user, "username", "")
        chat_id = query.message.chat.id
        
        # –ü–æ–ª—É—á–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–∑ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        old_reg_data = context.user_data.get('registration_data', {})
        phone = old_reg_data.get('phone', '')
        
        # –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å –±–∞–∑–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
        context.user_data['registration_data'] = {
            "telegram_id": user_id,
            "first_name": first_name,
            "last_name": last_name,
            "username": username,
            "phone": phone,
            "chat_id": chat_id,
            "status": "pending",
            "role": "user"
        }
        
        # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –§–ò–û
        context.user_data['waiting_for_full_name'] = True
        
        await query.edit_message_text(...)
```

## üîß –ö–õ–Æ–ß–ï–í–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø

### 1. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö**
- –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ `query.from_user`
- –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–∑ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- –ü–æ–ª—É—á–∞–µ–º `chat_id` –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è

### 2. **–ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö**
- –í–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É `registration_data`
- –ó–∞–ø–æ–ª–Ω—è–µ–º –±–∞–∑–æ–≤—ã–µ –ø–æ–ª—è, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, —á—Ç–æ–±—ã –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –µ–≥–æ –∑–∞–Ω–æ–≤–æ

### 3. **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ**
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º `waiting_for_full_name = True`
- –û—á–∏—â–∞–µ–º –¥—Ä—É–≥–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–∂–∏–¥–∞–Ω–∏—è

## üöÄ –†–ï–ó–£–õ–¨–¢–ê–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### ‚úÖ –ß—Ç–æ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–∞–∂–∞—Ç—å "‚ùå –ï—Å—Ç—å –æ—à–∏–±–∫–∏"
   - –°–∏—Å—Ç–µ–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–Ω–µ –Ω—É–∂–Ω–æ –≤–≤–æ–¥–∏—Ç—å –∑–∞–Ω–æ–≤–æ)

2. **–í–≤–æ–¥ –§–ò–û –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç**
   - –§—É–Ω–∫—Ü–∏—è `handle_full_name_input()` –Ω–∞—Ö–æ–¥–∏—Ç `registration_data`
   - –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –±–µ–∑ –æ—à–∏–±–æ–∫

3. **–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç**
   - –í–≤–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ‚Üí –§–ò–û ‚Üí –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
   - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –ª—é–±–æ–º —ç—Ç–∞–ø–µ
   - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

## üìù –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –†–ï–®–ï–ù–ò–ï

### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Ç–µ–ª–µ—Ñ–æ–Ω
   ‚Üì
2. –°–æ–∑–¥–∞–µ—Ç—Å—è registration_data —Å –±–∞–∑–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
   ‚Üì
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –§–ò–û –∏ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è
   ‚Üì
4. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
   ‚Üì
5a. –ï—Å–ª–∏ "‚úÖ –í—Å–µ –≤–µ—Ä–Ω–æ" ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
5b. –ï—Å–ª–∏ "‚ùå –ï—Å—Ç—å –æ—à–∏–±–∫–∏" ‚Üí –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –±–∞–∑–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:
```python
context.user_data['registration_data'] = {
    "telegram_id": user_id,        # ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
    "first_name": first_name,      # –ò–º—è –∏–∑ Telegram
    "last_name": last_name,        # –§–∞–º–∏–ª–∏—è –∏–∑ Telegram  
    "username": username,          # Username –∏–∑ Telegram
    "phone": phone,                # –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ)
    "chat_id": chat_id,           # ID —á–∞—Ç–∞
    "status": "pending",           # –°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏
    "role": "user",               # –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    "full_name": "...",           # –§–ò–û (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –≤–≤–æ–¥–µ)
    "birth_date": "..."           # –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –≤–≤–æ–¥–µ)
}
```

## ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ú–û–ú–ï–ù–¢–´

1. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞**
   - –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–µ —Ç–µ—Ä—è–µ—Ç—Å—è
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–µ –Ω—É–∂–Ω–æ –∑–∞–Ω–æ–≤–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç
   - –ü—Ä–æ—Ü–µ—Å—Å —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –±–æ–ª–µ–µ —É–¥–æ–±–Ω—ã–º

2. **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π**
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ `waiting_for_full_name`
   - –û—á–∏—â–∞—é—Ç—Å—è –¥—Ä—É–≥–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–∂–∏–¥–∞–Ω–∏—è
   - –°–∏—Å—Ç–µ–º–∞ –∑–Ω–∞–µ—Ç, –∫–∞–∫–æ–π –≤–≤–æ–¥ –æ–∂–∏–¥–∞—Ç—å –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

3. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
   - –†–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –ù–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

## üîß –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø

–î–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:

1. **–í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –§–ò–û –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞ –ø–æ –¥–∞—Ç–µ —Ä–æ–∂–¥–µ–Ω–∏—è

2. **–£–ª—É—á—à–µ–Ω–Ω—ã–π UX**
   - –ü–æ–∫–∞–∑ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (—à–∞–≥ X –∏–∑ Y)
   - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
   - –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö

3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —ç—Ç–∞–ø–æ–≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–º/–Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è–º
   - –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –º–µ—Å—Ç –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–û–ë–õ–ï–ú–ê –ü–ï–†–ï–ó–ê–ü–£–°–ö–ê –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò –ò–°–ü–†–ê–í–õ–ï–ù–ê
**–î–∞—Ç–∞:** 31.07.2025
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í–´–°–û–ö–ò–ô
**–í–µ—Ä—Å–∏—è:** v2.6.0-restart-fixed
