# Система учета рабочего времени через QR-коды

## Описание системы

Система состоит из трех компонентов:
1. **Веб-страница** (main.py) - генерация QR-кодов для филиалов
2. **Telegram-бот** (bot.py) - сканирование QR-кодов и учет времени
3. **Планировщик** (auto_close_scheduler.py) - автоматическое закрытие рабочего дня в 21:00

## Функционал

### Веб-страница
- Выбор филиала из списка
- Генерация QR-кода с подписью (обновляется каждые 30 секунд)
- Защита от подделки через HMAC-подпись

### Telegram-бот
- **Регистрация пользователей**: только с номером телефона и подтверждением админа
- **Авторизация**: только одобренные пользователи могут работать
- **Сканирование QR**: через текст или фото
- **Логика приход/уход**: чередование событий (нельзя 2 раза подряд прийти/уйти)
- **Расчет рабочих часов**: автоматический при уходе

### Автозакрытие
- Каждый день в 21:00 система проверяет незакрытые рабочие дни
- Автоматически создает событие ухода с 8 часами работы
- Отправляет уведомления пользователю и админу о нарушении

## Настройка

### 1. Установка зависимостей
```bash
pip install -r requirements.txt
```

### 2. Настройка переменных окружения (.env)
```env
# Telegram
TELEGRAM_TOKEN=ваш_токен_бота_от_BotFather

# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://ваш_проект.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=ваш_anon_key

# QR подпись (одинаковый для веб-страницы и бота)
QR_SECRET=ваша_секретная_строка_для_подписи
```

### 3. Создание таблиц в Supabase

Выполните SQL-скрипты в следующем порядке:

1. **create_users.sql** - таблица пользователей
2. **create_time_events.sql** - таблица событий времени
3. **create_branches.sql** - таблица филиалов

### 4. Заполнение данных

Добавьте филиалы в таблицу `branches`:
```sql
INSERT INTO branches (id, name, address) VALUES 
(1, 'Проспект Победы', 'пр. Победы'),
(2, 'Гвардейская', 'ул. Гвардейская'),
(3, 'Чистопольская', 'ул. Чистопольская');
```

## Запуск системы

### 1. Запуск веб-страницы (генерация QR)
```bash
python main.py
```
Откройте браузер: http://localhost:8080

### 2. Запуск Telegram-бота
```bash
python bot.py
```

### 3. Запуск планировщика автозакрытия
```bash
python auto_close_scheduler.py
```

## Использование

### Для администратора (username: gayazking)
1. Запустить /start в боте для активации
2. Получать и обрабатывать заявки на регистрацию
3. Получать уведомления об автозакрытии рабочих дней.

### Для сотрудников
1. Написать /start боту
2. Отправить номер телефона через кнопку
3. Дождаться подтверждения от админа
4. Сканировать QR-коды на терминалах
5. Выбирать "Пришел" или "Ушел" после сканирования

### Логика работы
- **Первое сканирование**: только "Пришел"
- **После прихода**: только "Ушел"
- **После ухода**: только "Пришел"
- **Автозакрытие**: если не отсканировал уход до 21:00

## Структура базы данных

### Таблица users
- Хранит данные пользователей Telegram
- Статусы: pending, approved, declined
- Роли: user, admin

### Таблица time_events
- Все события прихода/ухода
- Типы: arrival, departure
- Флаг автозакрытия: is_auto_closed
- Рабочие часы: work_hours

### Таблица branches
- Список филиалов для выбора

## Безопасность

- QR-коды защищены HMAC-подписью
- Время жизни QR-кода: 30 секунд
- Только авторизованные пользователи могут работать
- Все действия логируются

## Мониторинг

- Логи бота выводятся в консоль
- Уведомления админу о всех нарушениях
- Автоматические отчеты о незакрытых днях
