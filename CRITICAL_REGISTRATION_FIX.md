# üö® –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú –° –†–ï–ì–ò–°–¢–†–ê–¶–ò–ï–ô

## ‚ùå –ù–ê–ô–î–ï–ù–ù–ê–Ø –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê

**–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ –æ—à–∏–±–æ–∫ "‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö" –∏ "–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–∏—Å—Ç–µ–º–æ–π":**

### üî• –û–¢–°–£–¢–°–¢–í–ò–ï –ó–ê–ì–†–£–ó–ö–ò –ü–ï–†–ï–ú–ï–ù–ù–´–• –û–ö–†–£–ñ–ï–ù–ò–Ø

–í —Ñ–∞–π–ª–µ `bot/bot.py` **–ù–ï –ó–ê–ì–†–£–ñ–ê–õ–ò–°–¨ –ü–ï–†–ï–ú–ï–ù–ù–´–ï –û–ö–†–£–ñ–ï–ù–ò–Ø** –∏–∑ —Ñ–∞–π–ª–∞ `.env`!

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# –í –∫–æ–¥–µ –±—ã–ª –∏–º–ø–æ—Ä—Ç:
from dotenv import load_dotenv

# –ù–û –ù–ï –ë–´–õ–û –í–´–ó–û–í–ê:
# load_dotenv()  # ‚Üê –≠–¢–û –û–¢–°–£–¢–°–¢–í–û–í–ê–õ–û!

# –ü–æ—ç—Ç–æ–º—É –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –±—ã–ª–∏ None:
TELEGRAM_TOKEN = os.environ.get("TELEGRAM_TOKEN")  # = None
QR_SECRET = os.environ.get("QR_SECRET")            # = None  
SUPABASE_URL = os.environ.get("NEXT_PUBLIC_SUPABASE_URL")   # = None
SUPABASE_KEY = os.environ.get("NEXT_PUBLIC_SUPABASE_ANON_KEY") # = None
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚ùå –ë–æ—Ç –Ω–µ –º–æ–≥ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö Supabase
- ‚ùå –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î –ø–∞–¥–∞–ª–∏ —Å –æ—à–∏–±–∫–∞–º–∏
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è
- ‚ùå –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∞

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1. **–î–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ load_dotenv()**
```python
# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è (UTC+3)
MOSCOW_TZ = timezone(timedelta(hours=3))
```

### 2. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤**
```python
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—É—é –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞
temp_dir = tempfile.gettempdir()
photo_filename = f"temp_qr_{uuid.uuid4().hex[:8]}.jpg"
photo_path = os.path.join(temp_dir, photo_filename)
```

### 3. **–£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**
```python
async def check_user_authorization(user_id):
    try:
        user_query = supabase.table("users").select("*").eq("telegram_id", user_id).execute()
        if not user_query.data:
            logging.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö")
            return False
        
        user_data = user_query.data[0]
        is_authorized = user_data.get("status") == "approved"
        logging.info(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: —Å—Ç–∞—Ç—É—Å={user_data.get('status')}, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω={is_authorized}")
        return is_authorized
        
    except Exception as e:
        logging.exception(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}")
        return False
```

### 4. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ QR_SECRET**
```python
def verify_signature(branch_id, time_window, signature):
    if not QR_SECRET:
        logging.error("QR_SECRET –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        return False
    
    try:
        msg = f"{branch_id}:{time_window}".encode()
        secret = QR_SECRET.encode()
        expected = hmac.new(secret, msg, hashlib.sha256).hexdigest()
        return hmac.compare_digest(signature, expected)
    except Exception as e:
        logging.exception("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏ QR-–∫–æ–¥–∞:")
        return False
```

### 5. **–£–±—Ä–∞–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –≤ Docker**
```yaml
# –í docker-compose.yml –£–î–ê–õ–ï–ù–û:
# user: root
# volumes:
#   - ./temp:/app/temp

# –û–°–¢–ê–í–õ–ï–ù–û:
bot:
  <<: *qr_image
  command: python -u bot/bot.py
  volumes:
    - ./:/app 
```

## üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–†–û–ë–õ–ï–ú–´

### –ö–∞–∫ —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ:

1. **–ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–ª—Å—è**, –Ω–æ `load_dotenv()` –Ω–µ –≤—ã–∑—ã–≤–∞–ª—Å—è
2. **–í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –±—ã–ª–∏ `None`**
3. **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–æ** (URL –∏ KEY = None)
4. **–õ—é–±—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î –ø–∞–¥–∞–ª–∏** —Å –æ—à–∏–±–∫–∞–º–∏
5. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞–ª–∏ –æ—à–∏–±–∫–∏** –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### –ü–æ—á–µ–º—É —ç—Ç–æ –Ω–µ –±—ã–ª–æ –∑–∞–º–µ—Ç–Ω–æ —Å—Ä–∞–∑—É:

- –ö–æ–¥ **–Ω–µ –ø–∞–¥–∞–ª —Å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–æ–π**
- Exception'—ã **–ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–ª–∏—Å—å** –∏ –≤–æ–∑–≤—Ä–∞—â–∞–ª–∏ `False`
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥–µ–ª–∏ —Ç–æ–ª—å–∫–æ **–æ–±—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö**
- –í –ª–æ–≥–∞—Ö –±—ã–ª–∏ –æ—à–∏–±–∫–∏, –Ω–æ **–Ω–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ**

## üöÄ –†–ï–ó–£–õ–¨–¢–ê–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

### ‚úÖ –ß—Ç–æ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**
   - TELEGRAM_TOKEN –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ .env
   - SUPABASE_URL –∏ SUPABASE_KEY –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ .env
   - QR_SECRET –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ .env

2. **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç**
   - Supabase –∫–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
   - –ó–∞–ø—Ä–æ—Å—ã –∫ –ë–î –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
   - –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–∏—Ç–∞—é—Ç—Å—è –∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è

3. **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
   - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ approved/pending/declined —Å—Ç–∞—Ç—É—Å–æ–≤
   - –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

4. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç**
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü—É users
   - –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
   - –ü—Ä–æ—Ü–µ—Å—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞—è–≤–æ–∫

5. **–û–±—Ä–∞–±–æ—Ç–∫–∞ QR-–∫–æ–¥–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º QR_SECRET
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –≤ time_events
   - –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## üìù –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Æ

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker-compose down

# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑—ã —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏
docker-compose build --no-cache

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å –Ω–æ–≤—ã–º –∫–æ–¥–æ–º
docker-compose up -d
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –±–æ—Ç–∞
docker-compose logs -f bot

# –î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ —É—Å–ø–µ—à–Ω–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ Supabase
# –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—à–∏–±–æ–∫ "QR_SECRET –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
```

### 3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:
1. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–æ–≤—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∑–∞—è–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
3. –û–¥–æ–±—Ä–∏—Ç—å –∑–∞—è–≤–∫—É —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∞
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–æ–≤

## ‚ö†Ô∏è –í–ê–ñ–ù–û

–≠—Ç–∞ –æ—à–∏–±–∫–∞ –±—ã–ª–∞ **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π** –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ –≤—Å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –±–æ—Ç–∞:
- ‚ùå –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∞
- ‚ùå –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∞  
- ‚ùå QR-–∫–æ–¥—ã –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏—Å—å
- ‚ùå –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –±—ã–ª–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è **–í–°–ï —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å**.

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ò–°–ü–†–ê–í–õ–ï–ù–ê
**–î–∞—Ç–∞:** 31.07.2025
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í–´–°–û–ö–ò–ô
**–í–µ—Ä—Å–∏—è:** v2.3.0-critical-fix
