name: Deploy QR-BOT_ALMAZ

on:
  push:
    branches: [ main ]          # Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¸Ğ¼ Ğ²ÑÑ‘, Ñ‡Ñ‚Ğ¾ ÑƒÑ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ² main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. Ğ‘ĞµÑ€Ñ‘Ğ¼ ĞºĞ¾Ğ´ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. ĞŸĞ¾Ğ´Ğ½Ğ¸Ğ¼Ğ°ĞµĞ¼ SSH-Ñ‚ÑƒĞ½Ğ½ĞµĞ»ÑŒ Ğ¸ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¸Ğ¼
    - name: SSH into server and deploy
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_KEY }}
        # â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SSH-ÑĞºÑ€Ğ¸Ğ¿Ñ‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        script: |
          set -e

          echo "=== ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ ==="
          if [ ! -d ~/qr-bot-almaz ]; then
            echo "ĞŸÑ€Ğ¾ĞµĞºÑ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ â€” ĞºĞ»Ğ¾Ğ½Ğ¸Ñ€ÑƒĞµĞ¼..."
            git clone https://github.com/${{ github.repository }} ~/qr-bot-almaz
          fi

          cd ~/qr-bot-almaz

          echo "=== ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ´ Ğ´Ğ¾ latest main ==="
          git fetch origin
          git reset --hard origin/main

          # ĞĞ• Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ .env, ĞµÑĞ»Ğ¸ Ğ¾Ğ½ ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ
          cp -n .env.example .env || true

          echo "=== ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹ ==="
          docker compose down || true            # Ğ½Ğ¾Ğ²Ğ°Ñ CLI 'docker compose', Ğ½Ğµ 'docker-compose'

          echo "=== Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑĞ²ĞµĞ¶Ğ¸Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ· ==="
          docker compose build --pull            # Ñ‚ÑĞ½ĞµĞ¼ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ñ… Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²
          docker compose up -d --remove-orphans

          echo "=== Ğ§Ğ¸ÑÑ‚Ğ¸Ğ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ dangling-Ğ¾Ğ±Ñ€Ğ°Ğ·Ñ‹ Ğ¸ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹ ==="
          docker image prune -af || true
          docker container prune -f || true

          echo "=== ğŸš€ Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ QR-BOT_ALMAZ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ==="
        # â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯